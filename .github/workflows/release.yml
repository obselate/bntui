name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    strategy:
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            name: bntui-linux-x86_64
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-latest
            name: bntui-linux-aarch64
          - target: x86_64-apple-darwin
            os: macos-latest
            name: bntui-macos-x86_64
          - target: aarch64-apple-darwin
            os: macos-latest
            name: bntui-macos-aarch64
          - target: x86_64-pc-windows-msvc
            os: windows-latest
            name: bntui-windows-x86_64.exe

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross-compilation tools (Linux aarch64)
        if: matrix.target == 'aarch64-unknown-linux-gnu'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu
          echo "CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc" >> $GITHUB_ENV

      - name: Build
        run: cargo build --release --target ${{ matrix.target }}

      - name: Rename binary (unix)
        if: runner.os != 'Windows'
        run: cp target/${{ matrix.target }}/release/bntui ${{ matrix.name }}

      - name: Rename binary (windows)
        if: runner.os == 'Windows'
        run: cp target/${{ matrix.target }}/release/bntui.exe ${{ matrix.name }}

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}
          path: ${{ matrix.name }}

  release:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: artifacts/*

  chocolatey:
    needs: release
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: bntui-windows-x86_64.exe
          path: artifacts

      - name: Compute checksum and update install script
        shell: pwsh
        run: |
          $hash = (Get-FileHash artifacts/bntui-windows-x86_64.exe -Algorithm SHA256).Hash
          $version = "${{ github.ref_name }}".TrimStart('v')
          $install = Get-Content choco/tools/chocolateyinstall.ps1 -Raw
          $install = $install -replace "(?<=\`$version = ').*?(?=')", $version
          $install = $install -replace "(?<=-Checksum64 ').*?(?=')", $hash
          Set-Content -Path choco/tools/chocolateyinstall.ps1 -Value $install
          Write-Host "Version: $version"
          Write-Host "SHA256: $hash"

      - name: Update nuspec version
        shell: pwsh
        run: |
          $version = "${{ github.ref_name }}".TrimStart('v')
          $nuspec = Get-Content choco/bntui.nuspec -Raw
          $nuspec = $nuspec -replace '(?<=<version>).*?(?=</version>)', $version
          $nuspec = $nuspec -replace '(?<=releases/tag/v).*?(?=</releaseNotes>)', $version
          Set-Content -Path choco/bntui.nuspec -Value $nuspec

      - name: Pack and push
        shell: pwsh
        run: |
          $version = "${{ github.ref_name }}".TrimStart('v')
          choco pack choco/bntui.nuspec --outputdirectory choco
          choco push "choco/bntui.${version}.nupkg" --source https://push.chocolatey.org/ --api-key ${{ secrets.CHOCO_API_KEY }}
